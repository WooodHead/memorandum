---
title: Fluentd
---

## Fluentd


## CLi

```
fluend [Options]
    -s, --setup [DIR=/etc/fluent]    install sample configuration file to the directory
    -c, --config PATH                config file path (default: /etc/fluent/fluent.conf)
        --dry-run                    Check fluentd setup is correct or not
        --show-plugin-config=PLUGIN  Show PLUGIN configuration and exit(ex: input:dummy)
    -p, --plugin DIR                 add plugin directory
    -I PATH                          add library path
    -r NAME                          load library
    -d, --daemon PIDFILE             daemonize fluent process
        --no-supervisor              run without fluent supervisor
        --user USER                  change user
        --group GROUP                change group
    -o, --log PATH                   log file path
    -i CONFIG_STRING,                inline config which is appended to the config file on-fly
        --inline-config
        --emit-error-log-interval SECONDS
                                     suppress interval seconds of emit error logs
        --suppress-repeated-stacktrace [VALUE]
                                     suppress repeated stacktrace
        --without-source             invoke a fluentd without input plugins
        --use-v1-config              Use v1 configuration format (default)
        --use-v0-config              Use v0 configuration format
    -v, --verbose                    increase verbose level (-v: debug, -vv: trace)
    -q, --quiet                      decrease verbose level (-q: warn, -qq: error)
        --suppress-config-dump       suppress config dumping when fluentd starts
    -g, --gemfile GEMFILE            Gemfile path
    -G, --gem-path GEM_INSTALL_PATH  Gemfile install path (default: $(dirname $gemfile)/vendor/bundle)
```

## Preinstallation
* [Before Installing Fluentd | Fluentd](https://docs.fluentd.org/v0.12/articles/before-install)


* Set up NTP
    * 重要
    * AWSでは、AWS (Amazon Web Services) users we recommend to use Amazon Time Sync Serviceを使う
* Increase Max number of File Descriptors
    * `ulimit -n`
        * file descriptorの上限
        * `1024`であれば、insufficient
        * `65536`くらいであれば、large deploymentでも安全o
    * 具体的には以下の設定値を参考にして消えmる
    * `in_tail`
        * The number of watching files
    * `in_forward`
        * The number of incoming access
    * `buf_file`
        * The number of buffer chunks. It is configured via buffer parameters
    * `output`
        * The used file descriptors are less than others. Temporary file for upload, connection pooling in the client library, etc
* Optimize Network Kernel Parameters
    * `/etc/sysctl.conf`

```conf
net.core.somaxconn = 1024
net.core.netdev_max_backlog = 5000
net.core.rmem_max = 16777216
net.core.wmem_max = 16777216
net.ipv4.tcp_wmem = 4096 12582912 16777216
net.ipv4.tcp_rmem = 4096 12582912 16777216
net.ipv4.tcp_max_syn_backlog = 8096
net.ipv4.tcp_slow_start_after_idle = 0
net.ipv4.tcp_tw_reuse = 1
net.ipv4.ip_local_port_range = 10240 65535
```


## Config

### source
input pluginを指定する。
sourceはいくらでも指定できる。
defaultのinput pluignとして、`forward`と`http`が利用できる。

* type
    * forward
        * TCP packetsをうけつる
        * portでうけつけるport番号を指定する
    * http
        * fluentdがhttpアクセスをうけつけ
        * portでうけつけるport番号を指定する

```
<source>
    type forward
    port 2323
</source>
```


tcpの場合は、json messageにtagを含めておくる。

```
stream:
  message...

message:
  [tag, time, record]
  or
  [tag, [[time,record], [time,record], ...]]

example:
  ["myapp.access", 1308466941, {"a":1}]["myapp.messages", 1308466942, {"b":2}]
  ["myapp.access", [[1308466941, {"a":1}], [1308466942, {"b":2}]]]
```

httpの場合は、URLのpathの部分がtagとなる。


### match
他のsystemにoutputする。
output pluginとも呼ばれる。

tagにmatchしたsourceからの入力のみ出力する。

```
# Match events tagged with "myapp.access" and
# store them to /var/log/fluent/access.%Y-%m-%d
# Of course, you can control how you partition your data
# with the time_slice_format option.
<match myapp.access>
    @type file
    path /var/log/fluent/access
</match>
```

typeでoutput pluginを指定。

上記の例では、`http://this.host:9880/myapp.access?json={"event":"data"}`のアクセスに対して、`{"event":"data"}`がpathに出力される。

* Match Order
    * 複数にmatchする場合は最初にmatchしたものが使われる
    * 複数に贈りたい場合は、`out_copy` pluginを使う必要がある

## Plugins
sourceでinput pluginを指定する。
matchでoutput pluiginを指定する。
以下のpluginがある。

* input
* output
* filter
* formatter
* buffer
    * output pluginsで使われる

### GCP
* [GoogleCloudPlatform/fluentd-catch-all-config: Collection of configuration files for the Fluentd log collection agent. Intended to enable the automagic collection of most logs generated by many of the most popular applications run in the cloud.](https://github.com/GoogleCloudPlatform/fluentd-catch-all-config)
* [GoogleCloudPlatform/google-fluentd: Packaging scripts for google-fluentd](https://github.com/GoogleCloudPlatform/google-fluentd)


## Reference
* [Configuration File Syntax | Fluentd](http://docs.fluentd.org/v0.12/articles/config-file#1-ldquosourcerdquo-where-all-the-data-come-from)

